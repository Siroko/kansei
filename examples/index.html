<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example WebGPU Renderer</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { Renderer } from '../src/renderers/Renderer'
      import { Texture } from '../src/buffers/Texture'
      import { Sampler } from '../src/buffers/Sampler'
      import { shaderCode } from './assets/shaders/TexturedCube'
      import { Material } from '../src/materials/Material'
      import { BoxGeometry } from '../src/geometries/BoxGeometry'
      import { Mesh } from '../src/objects/Mesh'
      import { Scene } from '../src/objects/Scene'
      import { Camera } from '../src/cameras/Camera'
      import { VideoTexture } from '../src/buffers/VideoTexture'
      import { Vector4 } from '../src/math/Vector4'
      import { TextureLoader } from '../src/loaders/TextureLoader'

      const renderer = new Renderer();
      await renderer.initialize();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement)

      const scene = new Scene();
      const camera = new Camera(75, 0.1, 100, window.innerWidth / window.innerHeight);
      camera.position.z = 10;
      const tl = new TextureLoader();
      const imageBitmap = await tl.load("./assets/textures/character_sheet_without_black.jpg");
      const texture = new Texture(imageBitmap);
      const sampler = new Sampler('linear', 'linear');
      const material = new Material(shaderCode, [
        {
          binding: 0,
          visibility: GPUShaderStage.FRAGMENT,
          value: texture
        },
        {
          binding: 1,
          visibility: GPUShaderStage.FRAGMENT,
          value: sampler
        }
      ]);
      const geometry = new BoxGeometry(1, 1, 1);
      const meshes = [];
      for (let i = 0; i < 500; i++) {
        const mesh = new Mesh(geometry, material);
        mesh.position.x = (Math.random() - 0.5) * 10;
        mesh.position.y = (Math.random() - 0.5) * 10;
        scene.add(mesh);
        meshes.push(mesh);
      }

      function animate() {
        let i = 0;
        meshes.forEach(mesh => {
          const iNorm = (i / meshes.length - 0.5);
          mesh.rotation.x += 0.01 * (iNorm + 1) * 0.1;
          mesh.rotation.y += 0.01 * (iNorm + 1);
          mesh.rotation.z += 0.01 * (iNorm + 1);
          mesh.position.x = (iNorm * 10) + Math.sin(Date.now() / 1000);
          i++;
        });

        renderer.render(scene, camera);
        
        requestAnimationFrame(animate);
      }
      animate();
    </script>
  </body>
</html>